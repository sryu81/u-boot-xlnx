# u-boot for picozed and BNL/LBL PSC

See upstream u-boot [README](README).

## Scope

Build U-Boot for BNL/LBL Power Supply Controller,
based on PicoZed 7030 SOM.

## Requirements

- Xilinx Vitis (tested on 2024.2, likely a loose dependency)
- A `fsbl.elf` generated by Vitis along with the target application

## Build u-boot

Tested on Debian 12.

```sh
# Debian system dependencies
sudo apt-get install git libssl-dev uuid-dev libgnutls-dev

# Common build steps

git clone https://github.com/mdavidsaver/u-boot-xlnx u-boot
cd u-boot

. path/to/settings64.sh

make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- \
  distclean

make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- \
  xilinx_zynq_picozed_psc_defconfig

make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- \
  all
```

Result `u-boot.elf`.

## Assemble BOOT.bin

To create a bootable image, the resulting `u-boot.elf`
needs to be combined with an `fsbl.elf` from a Vitis
project for the target board using the `bootgen` tool.

```sh
cat <<EOF > u-boot.bif
u_boot:
{
        [bootloader]fsbl.elf
        u-boot.elf
}
EOF

bootgen -arch zynq -image u-boot.bif -w -o BOOT.bin
```

`BOOT.bin` should now be exist.

## Generate initial environment

Create a file `env.txt` with the followinginitial contents.
Replace `xx:xx:xx:xx:xx:xx` with actual device MAC address.

```
ethaddr=xx:xx:xx:xx:xx:xx
bootdelay=5
autostart=n
autoload=n
memaddr=30000000
elffile=psc.elf
bitfile=psc.bit
bootcmd=setenv autostart n\\
  dhcp\\
  tftpboot 0x\${memaddr} \${bitfile}\\
  fpga loadb 0 0x\${memaddr} 0x\${filesize}\\
  tftpboot 0x\${memaddr} \${elffile}\\
  setenv autostart y\\
  bootelf 0x\${memaddr}
```

Now create `uboot.env`

```sh
./tools/mkenvimage -r -s 0x20000 -o uboot.env env.txt

cp uboot.env uboot-redund.env
```

__NOTICE__ The `-r` and `-s` arguments must match u-boot build time configuration in `.config`.

The `-r` argument must be passed if `CONFIG_SYS_REDUNDAND_ENVIRONMENT` is enabled (default),
and omitted if it is not.  Failure to do so will result in `bad CRC`.

The value passed to `-s` should match `CONFIG_ENV_SIZE` from the u-boot `.config`.

__NOTICE__ The selection of 0x30000000 as the temporary load address must not
overlap with any of the address ranges used by `psc.elf`.
See `readelf` for details.

## Target SD card contents

Copy in:

- `BOOT.bin`  - FSBL + u-boot
- `uboot.env` - u-boot configuration
- `uboot-redund.env` - Identical copy of u-boot configuration
