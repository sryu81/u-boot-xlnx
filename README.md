# PSC firmware management strategy

ALS-U controls has planed to deploy hundreds of power supply controller for AR and SR.
We employed the u-boot to manage the firmware for the different PSC kinds centrally.

This approach requires DHCP and TFTP server in the network.

Here's a brief description of how the boot process looks like:

1. u-boot on the SD card sends the dhcp request to obtain the ip address, tftp server ip address and boot script file name.
2. DHCP sends these information to the requesters per ethenet address.
3. u-boot executes the boot script that downloads the bitstream file and elf file from the tftp server.
4. u-boot runs the boot sequence

Each device should have uinque MAC and IP address and asset ID.

The SD card of each device contains u-boot bin and env.txt which can be prepared by following procedure.
Also, the DHCP and TFTP configuration will be followed.

# u-boot for PSC SD card image

See upstream u-boot [README](README).

## Scope

Build U-Boot for Power Supply Controller,
based on PicoZed 7030 SOM. (Zynq-7000)

## Requirements

- Xilinx Vitis (tested on 2020.2, likely a loose dependency)
- A `fsbl.elf` generated by Vitis along with the target application

## Build u-boot

Tested on Rocky8.10, Debian 12 and Ubuntu 24.01 LTS

```sh
# Debian system dependencies
sudo apt-get install git libssl-dev uuid-dev libgnutls28-dev

# Rocky 8.10
sudo dnf install 

# Common build steps
git clone ssh://git@git-local.als.lbl.gov:8022/alsu/configuration/u-boot.git

- then you will see the u-boot directory only

cd u-boot

# Assuming your xilinx environment is under /opt/Xilinx/Vitis

source /opt/Xilinx/Vitis/<Version>/settings64.sh

make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean

make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- xilinx_zynq_picozed_psc_defconfig

make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- all
```

Result `u-boot.elf`.

## Assemble BOOT.bin

To create a bootable image, the resulting `u-boot.elf`
needs to be combined with an `fsbl.elf` from a Vitis
project for the target board using the `bootgen` tool.

```sh
cat <<EOF > u-boot.bif
u_boot:
{
        [bootloader]fsbl.elf
        u-boot.elf
}
EOF

bootgen -arch zynq -image u-boot.bif -w -o BOOT.bin
```

`BOOT.bin` should now be exist.

## Generate initial environment

Create a file `env.txt` with the followinginitial contents.
Replace `xx:xx:xx:xx:xx:xx` with actual device MAC address.
${bootfile} : this must be generated with mkimage tool and located in the tftp server 

```
ethaddr=xx:xx:xx:xx:xx:xx
bootdelay=5
autostart=n
autoload=n
bootcmd=setenv memaddr 0x38000000;dhcp;tftpboot ${memaddr} ${bootfile};source ${memaddr}
```

Now create `uboot.env`

```sh
./tools/mkenvimage -r -s 0x20000 -o uboot.env env.txt

cp uboot.env uboot-redund.env
```

__NOTICE__ The `-r` and `-s` arguments must match u-boot build time configuration in `.config`.

The `-r` argument must be passed if `CONFIG_SYS_REDUNDAND_ENVIRONMENT` is enabled (default),
and omitted if it is not.  Failure to do so will result in `bad CRC`.

The value passed to `-s` should match `CONFIG_ENV_SIZE` from the u-boot `.config`.

__NOTICE__ The selection of 0x38000000 as the temporary load address must not
overlap with any of the address ranges used by `psc.elf`.
See `readelf` for details.

## Target SD card contents

Copy in:

- `BOOT.bin`  - FSBL + u-boot
- `uboot.env` - u-boot configuration
- `uboot-redund.env` - Identical copy of u-boot configuration

## Generate bootfile

To accomodate the difference PSC variants, we need to generate 5 psc boot scripts : 

psc-2ch-hss.scr
psc-4ch-mss.scr
psc-4ch-msf.scr
psc-4ch-hss.scr
psc-4ch-hsf.scr

These files will be loaded as the device requests so it must be in the tftp root directory. (e.g. /srv/tftp/ )
In this example we create psc-2ch-hss.txt :

```
setenv loadaddr 0x30000000
setenv filesize 0x1000000
tftpboot ${loadaddr} psc/psc-2ch-hss.bit
fpga loadb 0 ${loadaddr} ${filesize} 
tftpboot ${loadaddr} psc/psc-2ch-hss.elf
setenv autostart y
bootelf ${loadaddr}
```

Now create "psc-2ch-hss.scr"
```
./tools/mkimage -A arm -T script -C none -n "PSC-2CH-HSS Boot Script" -d psc-2ch-hss.txt psc-2ch-hss.scr
```

# DHCP configuration file (/etc/dhcp/dhcpd.conf)

DHCP should be configured correctly.
Check firewall setting and routers to receive/send dhcp request and response packets between the different subnets.

```
subnet 10.16.18.0 netmask 255.255.255.0 {
    option subnet-mask 255.255.255.0;
    option broadcast-address 10.16.255.255;       # broadcast to other subnets
    option domain-name "als.private.lbl.gov";
    option routers 10.16.18.1;                    # check correct router to use

    host psc-01 {
        hardware ethernet XX:XX:XX:XX:XX:01;      
        fixed-address 10.16.17.11;                # ip address to be assigned to psc-01
        next-server 10.16.18.12;                  # TFTP server ip address
        filename "psc-2ch-hss.scr";               # Must match between the script name and MAC and IP address 
    }

    host psc-02 {
        hardware ethernet XX:XX:XX:XX:XX:02;
        fixed-address 10.16.17.12;
        next-server 10.16.18.12;
        filename "psc-4ch-msf.scr";
    }

    ...
}

```

# TFTP setup

place your psc boot script, in this case psc-2ch-hss.scr, to the tftp root directory:

```
/srv/tftp/psc-2ch-hss.scr
/srv/tftp/psc-4ch-mss.scr
/srv/tftp/psc-4ch-msf.scr
/srv/tftp/psc-4ch-hss.scr
/srv/tftp/psc-4ch-hsf.scr
```